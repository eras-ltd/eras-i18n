<link rel='import' href='../polymer/polymer.html'>
<!--
`eras-i18n`

Looks up and displays the resource specified by the key. Can display plain text and HTML. MarkDown will need to be converted to HTML before inclusion in the locale file.

First you need to load the locale file like this:

```html
<eras-i18n-locale path='/locale-en.json'></eras-i18n-locale>
```

Then you can display resources like this:

```html
<eras-i18n key='some-key' args='["cat","hat"]'></eras-i18n>
```

@demo demo/eras-i18n_demo.html
-->
<dom-module id='eras-i18n'>
  <template>

  </template>
  <script>
    Polymer({
      is: 'eras-i18n',
      properties: {
        /** The key for the desired resource */
        key: String,

        /**
         * An array of strings that will be substituted into the 
         * string specified by `key` using C# like `{0}` markers.
         * *Basically works a bit like C# `string.format()`*
         * @type {String[]}
         */
        args: {
          type: Array,
          value: []
        },

        /**
         * Signifies whether we are still waiting for the locale
         * file to be loaded.
         */
        waiting: {
          type: Boolean,
          notify: true,
          reflectToAttribute: true,
          observer: '_waitingChanged'
        },

        /**
         * **Only to be used for tests**
         * 
         * Set this to a random string, it then gets appended to 
         * the names of events that are fired and listened to.
         * Prevents other tests that are running async from 
         * interfering. *Make sure you set it to the same as
         * the one you set on `eras-i18n-locale`*
         */
        testScope: String
      },

      attached: function () {
        this.fire('eras-i18n-waiting' + this.testScope, { i18n: this });

        var self = this;
        document.addEventListener('eras-i18n-locale-loaded' + this.testScope, function () {
          self.waiting = false;
        });
      },

      /**
       * Observed changes to `waiting` and updates `innerHTML` 
       * by calling `_get` and `_substitute` once loaded.
       * @param {Boolean} waiting
       */
      _waitingChanged: function (waiting) {
        if (waiting) return;

        var content = this._get(this.key);

        if (content.success)
          content.value = this._substitute(content.value, this.args);

        this.innerHTML = content.value;
      },

      /**
       * Looks up the supplied key in the global `window.eras_i18n`
       * object and returns the associated value.
       * @param {String} key
       * @return {String}
       */
      _get: function (key) {
        if (window.eras_i18n === undefined) {
          console.warn('i18n object not defined');
          return { value: key, success: false };
        } else {
          if (window.eras_i18n.hasOwnProperty(key)) {
            return { value: window.eras_i18n[key], success: true }
          } else {
            console.warn('i18n warning: Could not find key: ' + key)
            return { value: key, success: false };
          }
        }
      },

      /**
       * Substitutes `{0}` format markers found in `value` for 
       * the corresponding string in `args`.
       * @param {String} value
       * @param {String[]}
       */
      _substitute: function (value, args) {
        for (var i = 0; i < args.length; i++)
          value = value.replace(new RegExp('\\{' + i + '\\}', 'g'), args[i]);

        return value;
      }
    });
  </script>
</dom-module>