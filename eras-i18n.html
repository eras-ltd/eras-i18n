<link rel='import' href='../polymer/polymer.html'>
<!--
`eras-i18n`

Looks up and displays the resource specified by the key. Can display plain text and HTML. MarkDown will need to be converted to HTML before inclusion in the locale file.

First you need to load the locale file like this:

```html
<eras-i18n-locale path='/locale-en.json'></eras-i18n-locale>
```

Then you can display resources like this:

```html
<eras-i18n key='some-key' arg0='cat' arg1='hat'></eras-i18n>
```

@demo demo/eras-i18n_demo.html
-->
<dom-module id='eras-i18n'>
  <template>

  </template>
  <script>
    Polymer({
      is: 'eras-i18n',
      properties: {
        /** The key for the desired resource */
        key: String,

        /** 
         * The resource specified by `key`, it is updated by 
         * `_waitingChanged` observer. 
         */
        _resource: String,

        /**
         * The first of a series of strings that will be substituted into 
         * the string specified by `key` using C# like `{0}` markers.
         */
        arg0: String,
        arg1: String,
        arg2: String,
        arg3: String,
        arg4: String,

        /**
         * Array that is filled with the values of `arg0` through `arg4`
         * when ever any of them are changed.
         * @type {String[]}
         */
        _args: {
          type: Array,
          value: []
        },

        /**
         * Signifies whether we are still waiting for the locale
         * file to be loaded.
         */
        waiting: {
          type: Boolean,
          notify: true,
          reflectToAttribute: true,
          observer: '_waitingChanged'
        },

        /**
         * **Only to be used for tests**
         * 
         * Set this to a random string, it then gets appended to 
         * the names of events that are fired and listened to.
         * Prevents other tests that are running async from 
         * interfering. *Make sure you set it to the same as
         * the one you set on `eras-i18n-locale`*
         */
        testScope: String
      },

      observers: [
        '_argsChanged(arg0)',
        '_argsChanged(arg1)',
        '_argsChanged(arg2)',
        '_argsChanged(arg3)',
        '_argsChanged(arg4)'
      ],

      attached: function () {
        this.fire('eras-i18n-waiting' + this.testScope, { i18n: this });

        var self = this;
        document.addEventListener('eras-i18n-locale-loaded' + this.testScope, function () {
          self.waiting = false;
        });
      },

      /**
       * Observes changes to `arg0` through `arg4` and fills `_args` if any of them
       * change, then filters out any empty ones. If `_resource` has been set then
       * it will call `_substitute` and update `innerHTML`.
       */
      _argsChanged: function (arg) {
        this._args = [this.arg0, this.arg1, this.arg2, this.arg3, this.arg4,];
        this._args = this._args.filter(function (a) { return a && a.length > 0; });

        if (this._resource)
          this.innerHTML = this._substitute(this._resource, this._args);
      },

      /**
       * Observed changes to `waiting` and updates `innerHTML` 
       * by calling `_get` and `_substitute` once loaded.
       * @param {Boolean} waiting
       */
      _waitingChanged: function (waiting) {
        if (waiting) return;

        var content = this._get(this.key);
        this._resource = content.resource;

        if (content.success)
          this.innerHTML = this._substitute(this._resource, this._args);
        else
          this.innerHTML = this.key;
      },

      /**
       * Looks up the supplied key in the global `window.eras_i18n`
       * object and returns the associated value.
       * @param {String} key
       * @return {String}
       */
      _get: function (key) {
        if (window.eras_i18n === undefined) {
          console.warn('i18n object not defined');
          return { success: false };
        } else {
          if (window.eras_i18n.hasOwnProperty(key)) {
            return { resource: window.eras_i18n[key], success: true }
          } else {
            console.warn('i18n warning: Could not find key: ' + key)
            return { success: false };
          }
        }
      },

      /**
       * Substitutes `{0}` format markers found in `value` for 
       * the corresponding string in `args`.
       * @param {String} value
       * @param {String[]}
       */
      _substitute: function (value, args) {
        for (var i = 0; i < args.length; i++)
          value = value.replace(new RegExp('\\{' + i + '\\}', 'g'), args[i]);

        return value;
      }
    });
  </script>
</dom-module>